#!/bin/bash

set -euo pipefail

cd "$(dirname "$0")/.."

mkdir -p dist
out="$(pwd)/dist"

tmp="$(mktemp -d)"
cleanup() { rm -rf "$tmp"; }
trap cleanup EXIT

version="$(git describe --tags --match='v*')"
version="${version#v}"

git archive master | tar xf - -C "$tmp"

cd "$tmp"

perl -p -i -e 's/\$VERSION\$/'"$version"'/g' */*.php

make

for project_yml in */project.yml; do
    project="$(dirname "$project_yml")"
    rm -f "$project/project.yml"
    zip -r9 out.zip "$project"
    mv out.zip "$out/wordpress-$project-$version.zip"
done
