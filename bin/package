#!/bin/bash

set -euo pipefail

cd "$(dirname "$0")/.."

mkdir -p dist
relout="dist"
out="$PWD/$relout"

tmp="$(mktemp -d)"
cleanup() { rm -rf "$tmp"; }
trap cleanup EXIT

version="$(git describe --tags --match='v*')"
version="${version#v}"

git archive master | tar xf - -C "$tmp"

cd "$tmp"

perl -p -i -e 's/\$VERSION\$/'"$version"'/g' */*.php

make >&2

for project_yml in */project.yml; do
    project="$(dirname "$project_yml")"
    file="wordpress-$project-$version.zip"
    rm -f "$project/project.yml"
    zip -r9 out.zip "$project" >&2
    mv out.zip "$out/$file"
    echo "$relout/$file"
done
