#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.."

projects=( webwinkelkeur evalor )

if [[ $# -eq 0 ]]; then :
elif [[ $# -eq 1 ]]; then
    ok=0
    for project in "${projects[@]}"; do
        if [[ $project = $1 ]]; then
            projects=( "$project" )
            ok=1
        fi
    done
    if [[ $ok -eq 0 ]]; then
        echo "Unknown project: $1" >&2
        exit 1
    fi
else
    echo "Usage: $0 [project]" >&2
    exit 1
fi

root="$PWD"

tmp="$(mktemp -d)"
trap "cd /; rm -rf '$tmp'" EXIT

./bin/package

for project in "${projects[@]}"; do
    if [[ $# -eq 1 ]] && [[ $1 != $project ]]; then
        continue
    fi

    cd "$tmp"

    rm -rf   package svn
    mkdir -p package svn

    svn co "http://plugins.svn.wordpress.org/$project" svn
    cd svn
    svn rm --force trunk
    mkdir trunk

    cd $tmp/package
    unzip -q $root/dist/wordpress-$project.zip
    mv $project/* $tmp/svn/trunk

    cd $tmp/svn
    svn add --force trunk
    svn ci -m 'Update plugin' --username apeschar
done
